#===----------------------------------------------------------------------===#
# This source file is part of github.com/apple/SwiftUsd
#
# Copyright Â© 2025 Apple Inc. and the SwiftUsd project authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#  https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
#===----------------------------------------------------------------------===#

name: Build SwiftUsd

inputs:
  openusd-ref:
    description: 'OpenUSD ref'
    required: true
    type: string

runs:
  using: "composite"
  steps:

  - name: Install CMake
    uses: ./.github/actions/install-cmake
        
  - name: Clone OpenUSD
    uses: actions/checkout@v5
    with:
      repository: PixarAnimationStudios/OpenUSD
      ref: ${{ inputs.openusd-ref }}
      path: ./openusd-source

  - name: Apply patch to OpenUSD
    run: |
      cd ./openusd-source
      patch -p1 -i ../openusd-patch.patch
    shell: bash

  - name: Build OpenUSD for macOS
    run: |
      cd ./openusd-source
      python3 build_scripts/build_usd.py \
        --embree \
        --imageio \
        --alembic \
        --openvdb \
        --no-python \
        --ignore-homebrew \
        --build-target native \
        ../openusd-builds/macOS
    shell: bash

  - name: Build OpenUSD for iOS
    run: |
      cd ./openusd-source
      python3 build_scripts/build_usd.py \
        --imageio \
        --alembic \
        --no-python \
        --ignore-homebrew \
        --build-target iOS \
        ../openusd-builds/iOS
    shell: bash

  - name: Remove Package.swift and swift-package
    run: |
      rm ./Package.swift
      rm -rf ./swift-package
    shell: bash

  - name: Run make-swift-package
    run: |
      swift run --package-path ./scripts/make-swift-package make-swift-package \
        ./openusd-builds/iOS \
        ./openusd-builds/macOS
    shell: bash
