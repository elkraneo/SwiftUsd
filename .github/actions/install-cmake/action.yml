#===----------------------------------------------------------------------===#
# This source file is part of github.com/apple/SwiftUsd
#
# Copyright Â© 2025 Apple Inc. and the SwiftUsd project authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#  https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
#===----------------------------------------------------------------------===#

# Installs CMake 3.26.5 for macOS

name: Install CMake

runs:
  using: "composite"
  steps:

  - name: Download CMake
    run: |
      curl https://github.com/Kitware/CMake/releases/download/v3.26.5/cmake-3.26.5-macos-universal.dmg \
        --output CMake.dmg
    working-directory: ${{ runner.temp }}
    shell: bash
    

  - name: Verify SHA256 checksum
    run: |
      # Hard-coded checksum taken from https://github.com/Kitware/CMake/releases/download/v3.26.5/cmake-3.26.5-SHA-256.txt,
      # cmake-3.26.5-macos-universal.dmg
      echo '18fb759bbdd04309be6a8e12920a8183ebbb17b331a6b7fc6a4071a68e5c81fd *CMake.dmg' | shasum -a 256 -c
    working-directory: ${{ runner.temp }}
    shell: bash
    

  - name: Attach DMG
    run: hdiutil attach CMake.dmg
    working-directory: ${{ runner.temp }}
    shell: bash

  - name: Copy app to permanent location
    run: |
      cp /Volumes/CMake/CMake.app ../CMake.app
      hdiutil detach /Volumes/CMake
    working-directory: ${{ github.workspace }
    shell: bash
      
  - name: Add CMake to PATH
    run: |
      # Note: `export PATH=` doesn't work for GitHub actions, the environment variable
      # must be set by redirecting into GITHUB_ENV
      echo "PATH=$PATH:$GITHUB_WORKSPACE/../CMake.app/Contents/bin" >> $GITHUB_ENV
    shell: bash

  - name: Test CMake is in PATH
    run: which cmake
    shell: bash